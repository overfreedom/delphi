Array.prototype.max=function(){return Math.max.apply(null,this)},Array.prototype.min=function(){return Math.min.apply(null,this)},Array.prototype.mean=function(){var r,i;for(r=0,i=0;r<this.length;r++)i+=this[r];return i/this.length},Array.prototype.rep=function(r){return Array.apply(null,new Array(r)).map(Number.prototype.valueOf,this[0])},Array.prototype.pip=function(r,i){var t,a,n=!1;for(t=0,a=this.length-1;t<this.length;a=t++)this[t][1]>i!=this[a][1]>i&&r<(this[a][0]-this[t][0])*(i-this[t][1])/(this[a][1]-this[t][1])+this[t][0]&&(n=!n);return n};var kriging=function(){var r={};return kriging_matrix_diag=function(r,i){var t,a=[0].rep(i*i);for(t=0;i>t;t++)a[t*i+t]=r;return a},kriging_matrix_transpose=function(r,i,t){var a,n,o=Array(t*i);for(a=0;i>a;a++)for(n=0;t>n;n++)o[n*i+a]=r[a*t+n];return o},kriging_matrix_scale=function(r,i,t,a){var n,o;for(n=0;t>n;n++)for(o=0;a>o;o++)r[n*a+o]*=i},kriging_matrix_add=function(r,i,t,a){var n,o,e=Array(t*a);for(n=0;t>n;n++)for(o=0;a>o;o++)e[n*a+o]=r[n*a+o]+i[n*a+o];return e},kriging_matrix_multiply=function(r,i,t,a,n){var o,e,g,l=Array(t*n);for(o=0;t>o;o++)for(e=0;n>e;e++)for(l[o*n+e]=0,g=0;a>g;g++)l[o*n+e]+=r[o*a+g]*i[g*n+e];return l},kriging_matrix_chol=function(r,i){var t,a,n,o=Array(i);for(t=0;i>t;t++)o[t]=r[t*i+t];for(t=0;i>t;t++){for(a=0;t>a;a++)o[t]-=r[t*i+a]*r[t*i+a];if(o[t]<=0)return!1;for(o[t]=Math.sqrt(o[t]),a=t+1;i>a;a++){for(n=0;t>n;n++)r[a*i+t]-=r[a*i+n]*r[t*i+n];r[a*i+t]/=o[t]}}for(t=0;i>t;t++)r[t*i+t]=o[t];return!0},kriging_matrix_chol2inv=function(r,i){var t,a,n,o;for(t=0;i>t;t++)for(r[t*i+t]=1/r[t*i+t],a=t+1;i>a;a++){for(o=0,n=t;a>n;n++)o-=r[a*i+n]*r[n*i+t];r[a*i+t]=o/r[a*i+a]}for(t=0;i>t;t++)for(a=t+1;i>a;a++)r[t*i+a]=0;for(t=0;i>t;t++){for(r[t*i+t]*=r[t*i+t],n=t+1;i>n;n++)r[t*i+t]+=r[n*i+t]*r[n*i+t];for(a=t+1;i>a;a++)for(n=a;i>n;n++)r[t*i+a]+=r[n*i+t]*r[n*i+a]}for(t=0;i>t;t++)for(a=0;t>a;a++)r[t*i+a]=r[a*i+t]},kriging_matrix_solve=function(r,i){var t,a,n,o,e,g,l,f,h,u,p,m=i,_=Array(i*i),s=Array(i),c=Array(i),y=Array(i);for(t=0;i>t;t++)for(o=0;i>o;o++)t==o?_[t*i+o]=1:_[t*i+o]=0;for(o=0;i>o;o++)y[o]=0;for(t=0;i>t;t++){for(f=0,o=0;i>o;o++)if(1!=y[o])for(e=0;i>e;e++)0==y[e]&&Math.abs(r[o*i+e])>=f&&(f=Math.abs(r[o*i+e]),n=o,a=e);if(++y[a],n!=a){for(g=0;i>g;g++)p=r[n*i+g],r[n*i+g]=r[a*i+g],r[a*i+g]=p;for(g=0;m>g;g++)p=_[n*i+g],_[n*i+g]=_[a*i+g],_[a*i+g]=p}if(c[t]=n,s[t]=a,0==r[a*i+a])return!1;for(u=1/r[a*i+a],r[a*i+a]=1,g=0;i>g;g++)r[a*i+g]*=u;for(g=0;m>g;g++)_[a*i+g]*=u;for(l=0;i>l;l++)if(l!=a){for(h=r[l*i+a],r[l*i+a]=0,g=0;i>g;g++)r[l*i+g]-=r[a*i+g]*h;for(g=0;m>g;g++)_[l*i+g]-=_[a*i+g]*h}}for(g=i-1;g>=0;g--)if(c[g]!=s[g])for(e=0;i>e;e++)p=r[e*i+c[g]],r[e*i+c[g]]=r[e*i+s[g]],r[e*i+s[g]]=p;return!0},kriging_variogram_gaussian=function(r,i,t,a,n){return i+(a-i)/t*(1-Math.exp(-(1/n)*Math.pow(r/t,2)))},kriging_variogram_exponential=function(r,i,t,a,n){return i+(a-i)/t*(1-Math.exp(-(1/n)*(r/t)))},kriging_variogram_spherical=function(r,i,t,a,n){return r>t?i+(a-i)/t:i+(a-i)/t*(1.5*(r/t)-.5*Math.pow(r/t,3))},r.train=function(r,i,t,a,n,o){var e={t:r,x:i,y:t,nugget:0,range:0,sill:0,A:1/3,n:0};switch(a){case"gaussian":e.model=kriging_variogram_gaussian;break;case"exponential":e.model=kriging_variogram_exponential;break;case"spherical":e.model=kriging_variogram_spherical}var g,l,f,h,u=r.length,p=Array((u*u-u)/2);for(g=0,f=0;u>g;g++)for(l=0;g>l;l++,f++)p[f]=Array(2),p[f][0]=Math.pow(Math.pow(i[g]-i[l],2)+Math.pow(t[g]-t[l],2),.5),p[f][1]=Math.abs(r[g]-r[l]);p.sort(function(r,i){return r[0]-i[0]}),e.range=p[(u*u-u)/2-1][0];var m=(u*u-u)/2>30?30:(u*u-u)/2,_=e.range/m,s=[0].rep(m),c=[0].rep(m);if(30>m)for(h=0;m>h;h++)s[h]=p[h][0],c[h]=p[h][1];else{for(g=0,l=0,f=0,h=0;m>g&&(u*u-u)/2>l;g++,f=0){for(;p[l][0]<=(g+1)*_&&(s[h]+=p[l][0],c[h]+=p[l][1],l++,f++,!(l>=(u*u-u)/2)););f>0&&(s[h]/=f,c[h]/=f,h++)}if(2>h)return e}u=h,e.range=s[u-1]-s[0];var y=[1].rep(2*u),v=Array(u),x=e.A;for(g=0;u>g;g++){switch(a){case"gaussian":y[2*g+1]=1-Math.exp(-(1/x)*Math.pow(s[g]/e.range,2));break;case"exponential":y[2*g+1]=1-Math.exp(-(1/x)*s[g]/e.range);break;case"spherical":y[2*g+1]=1.5*(s[g]/e.range)-.5*Math.pow(s[g]/e.range,3)}v[g]=c[g]}var M=kriging_matrix_transpose(y,u,2),k=kriging_matrix_multiply(M,y,2,u,2);k=kriging_matrix_add(k,kriging_matrix_diag(1/o,2),2,2);var A=k.slice(0);kriging_matrix_chol(k,2)?kriging_matrix_chol2inv(k,2):(kriging_matrix_solve(A,2),k=A);var d=kriging_matrix_multiply(kriging_matrix_multiply(k,M,2,2,u),v,2,u,1);e.nugget=d[0],e.sill=d[1]*e.range+e.nugget,e.n=i.length,u=i.length;var w=Array(u*u);for(g=0;u>g;g++){for(l=0;g>l;l++)w[g*u+l]=e.model(Math.pow(Math.pow(i[g]-i[l],2)+Math.pow(t[g]-t[l],2),.5),e.nugget,e.range,e.sill,e.A),w[l*u+g]=w[g*u+l];w[g*u+g]=e.model(0,e.nugget,e.range,e.sill,e.A)}var b=kriging_matrix_add(w,kriging_matrix_diag(n,u),u,u),z=b.slice(0);kriging_matrix_chol(b,u)?kriging_matrix_chol2inv(b,u):(kriging_matrix_solve(z,u),b=z);var w=b.slice(0),K=kriging_matrix_multiply(b,r,u,u,1);return e.K=w,e.M=K,e},r.predict=function(r,i,t){var a,n=Array(t.n);for(a=0;a<t.n;a++)n[a]=t.model(Math.pow(Math.pow(r-t.x[a],2)+Math.pow(i-t.y[a],2),.5),t.nugget,t.range,t.sill,t.A);return kriging_matrix_multiply(n,t.M,1,t.n,1)[0]},r.variance=function(r,i,t){var a,n=Array(t.n);for(a=0;a<t.n;a++)n[a]=t.model(Math.pow(Math.pow(r-t.x[a],2)+Math.pow(i-t.y[a],2),.5),t.nugget,t.range,t.sill,t.A);return t.model(0,t.nugget,t.range,t.sill,t.A)+kriging_matrix_multiply(kriging_matrix_multiply(n,t.K,1,t.n,t.n),n,1,t.n,1)[0]},r.grid=function(i,t,a){var n,o,e,g=i.length;if(0!=g){var l=[i[0][0][0],i[0][0][0]],f=[i[0][0][1],i[0][0][1]];for(n=0;g>n;n++)for(o=0;o<i[n].length;o++)i[n][o][0]<l[0]&&(l[0]=i[n][o][0]),i[n][o][0]>l[1]&&(l[1]=i[n][o][0]),i[n][o][1]<f[0]&&(f[0]=i[n][o][1]),i[n][o][1]>f[1]&&(f[1]=i[n][o][1]);var h,u,p=Array(2),m=Array(2),_=Array(2),s=Array(2),c=Math.ceil((l[1]-l[0])/a),y=Math.ceil((f[1]-f[0])/a),v=Array(c+1);for(n=0;c>=n;n++)v[n]=Array(y+1);for(n=0;g>n;n++){for(_[0]=i[n][0][0],_[1]=_[0],s[0]=i[n][0][1],s[1]=s[0],o=1;o<i[n].length;o++)i[n][o][0]<_[0]&&(_[0]=i[n][o][0]),i[n][o][0]>_[1]&&(_[1]=i[n][o][0]),i[n][o][1]<s[0]&&(s[0]=i[n][o][1]),i[n][o][1]>s[1]&&(s[1]=i[n][o][1]);for(p[0]=Math.floor((_[0]-(_[0]-l[0])%a-l[0])/a),p[1]=Math.ceil((_[1]-(_[1]-l[1])%a-l[0])/a),m[0]=Math.floor((s[0]-(s[0]-f[0])%a-f[0])/a),m[1]=Math.ceil((s[1]-(s[1]-f[1])%a-f[0])/a),o=p[0];o<=p[1];o++)for(e=m[0];e<=m[1];e++)h=l[0]+o*a,u=f[0]+e*a,i[n].pip(h,u)&&(v[o][e]=r.predict(h,u,t))}return v.xlim=l,v.ylim=f,v.zlim=[t.t.min(),t.t.max()],v.width=a,v}},r.contour=function(r,i,t){},r.plot=function(r,i,t,a,n){var o=r.getContext("2d");o.clearRect(0,0,r.width,r.height);var e,g,l,f,h,u=[t[1]-t[0],a[1]-a[0],i.zlim[1]-i.zlim[0]],p=i.length,m=i[0].length,_=Math.ceil(i.width*r.width/(t[1]-t[0])),s=Math.ceil(i.width*r.height/(a[1]-a[0]));for(e=0;p>e;e++)for(g=0;m>g;g++)void 0!=i[e][g]&&(l=r.width*(e*i.width+i.xlim[0]-t[0])/u[0],f=r.height*(1-(g*i.width+i.ylim[0]-a[0])/u[1]),h=(i[e][g]-i.zlim[0])/u[2],0>h&&(h=0),h>1&&(h=1),o.fillStyle=n[Math.floor((n.length-1)*h)],o.fillRect(Math.round(l-_/2),Math.round(f-s/2),_,s))},r}();