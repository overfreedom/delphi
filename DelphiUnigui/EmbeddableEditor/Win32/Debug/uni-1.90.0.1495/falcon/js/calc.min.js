Ext.define("Vdn.widget.Calc",{extend:"Ext.panel.Panel",requires:["Ext.Button"],alias:"widget.vdncalc",cls:"default-calc",activated:!0,dragging:!1,frame:!0,header:!1,x:0,y:0,configColorsEffect:{useopacity:!0,noActiveColor:"#F0F8FF",activeColor:"#E0E7EE"},calcs:{memory:0,result:null,input:null,operation:"",entered:!1},initComponent:function(){p=this,p.eventClickBtn=function(btn,e,calc){if("Error"!=calc.pickerField.value||"C"==btn.text){var curValue=parseFloat(calc.pickerField.value),mset=!1;switch(btn.text){case"C":calc.pickerField.setValue(0),calc.calcs.result=null,calc.calcs.input=null;break;case"MC":calc.calcs.memory=0,mset=!0;break;case"MR":calc.pickerField.setValue(calc.calcs.memory),calc.calcs.input=parseFloat(calc.pickerField.value),calc.calcs.entered=!0;break;case"MS":calc.calcs.memory=curValue,calc.calcs.entered=!0,mset=!0;break;case"M+":calc.calcs.memory+=curValue,calc.calcs.entered=!0,mset=!0;break;case"M-":calc.calcs.memory-=curValue,calc.calcs.entered=!0,mset=!0;break;case"1/x":0!=curValue?(calc.calcs.input=1/curValue,calc.pickerField.setValue(calc.calcs.input),calc.calcs.entered=!0):calc.pickerField.setValue("Error");break;case"&#8592;":break;case"CE":break;case"&#8723;":calc.pickerField.setValue(-1*curValue),calc.calcs.input=calc.pickerField.value;break;case"&#8730;":break;case"%":break;case",":null==calc.calcs.input?(calc.pickerField.setValue("0"+btn.text.replace(",",".")),calc.calcs.input=calc.pickerField.value):-1==calc.pickerField.value.toString().indexOf(".")&&calc.pickerField.setValue(curValue+""+btn.text.replace(",","."));break;default:if(btn.text.match(/\d/))"0"==calc.pickerField.value||null==calc.calcs.input||calc.calcs.entered?(calc.pickerField.setValue(btn.text),""==calc.calcs.operation,calc.calcs.entered=!1):calc.pickerField.setValue(calc.pickerField.value+""+btn.text),calc.calcs.input=calc.pickerField.value;else{if(null==calc.calcs.result)calc.calcs.result=calc.calcs.input;else if(null!=calc.calcs.input&&""!=calc.calcs.operation){var fixedPar=16;("+"==calc.calcs.operation||"-"==calc.calcs.operation)&&(fixedPar=Math.max(calc.calcs.input.toString().substr(calc.calcs.input.toString().indexOf(".")+1).length,calc.calcs.result.toString().substr(calc.calcs.result.toString().indexOf(".")+1).length)),fixedPar>16&&(fixedPar=16),calc.calcs.result=+eval(calc.calcs.result+calc.calcs.operation+calc.calcs.input).toFixed(fixedPar),calc.calcs.result==1/0||"NaN"==calc.calcs.result.toString()?(calc.pickerField.setValue("Error"),calc.calcs.result=0):calc.pickerField.setValue(calc.calcs.result)}else null!=calc.calcs.input&&(calc.calcs.result=calc.calcs.input);"="==btn.text?(calc.calcs.operation="",ajaxRequest(calc.pickerField,"select"),calc.close()):calc.calcs.operation=btn.text,calc.calcs.input=null}}mset&&(0==calc.calcs.memory?(calc.getComponent("MR").disable(),calc.getComponent("MC").disable()):(calc.getComponent("MR").enable(),calc.getComponent("MC").enable()))}};var arr_buttons=[{text:"MC",disabled:!0},{text:"MR",disabled:!0},{text:"MS"},{text:"M+"},{text:"M-"},{text:"&#8592;"},{text:"CE"},{text:"C"},{text:"&#8723;"},{text:"&#8730;"},{text:"7"},{text:"8"},{text:"9"},{text:"/"},{text:"%"},{text:"4"},{text:"5"},{text:"6"},{text:"*"},{text:"1/x"},{text:"1"},{text:"2"},{text:"3"},{text:"-"},{text:"=",rowspan:2},{text:"0",colspan:2},{text:","},{text:"+"}];p.items=[];for(var before_items=p.items.length,i=0;i<arr_buttons.length;i++){switch(arr_buttons[i].text){case"=":arr_buttons[i].cls="calc-buttons-eq";break;case"0":arr_buttons[i].cls="calc-buttons-zero";break;default:arr_buttons[i].cls="calc-buttons"}arr_buttons[i].itemId=arr_buttons[i].text;var btn=Ext.create("Ext.button.Button",arr_buttons[i]);p.items.push(btn),p.items[i+before_items].on("click",p.eventClickBtn,this,p)}p.draggable={moveOnly:!0,onMouseDown:function(){this.panel.dragging=!0},onMouseUp:function(){Ext.isIE||(this.panel.dragging=!1),this.panel.onClickToPanel()}},p.layout={type:"table",columns:5},p.onClickToPanel=function(){this.activated||(this.activated=!0,this.dragging=!1,Ext.isIE&&!Ext.isIE9p||!this.configColorsEffect.useopacity?this.setBodyStyle("background",this.configColorsEffect.activeColor):this.setBodyStyle("opacity",1))},p.onClickOutsidePanel=function(e){var c=this.getId();Ext.get(e.getTarget()).findParent("div#"+c)||e.getTarget().id==this.pickerField.triggerEl.elements[0].id||this.close()},p.onClose=function(){p.pickerField.picker=null,Ext.get(Ext.getBody()).un("mouseup",this.onClickOutsidePanel,this),p.clearListeners()},!Ext.isIE9p&&this.configColorsEffect.useopacity&&this.setBodyStyle("background",this.configColorsEffect.activeColor),p.callParent(arguments)},afterRender:function(){panel=this,panel.callParent(arguments),panel.el.on("click",panel.onClickToPanel,panel),panel.on("close",panel.onClose,panel),Ext.get(Ext.getBody()).on("mouseup",panel.onClickOutsidePanel,panel),panel.getComponent("=").height=panel.getComponent("=").getHeight()}});